<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Series de Taylor - Visualizador Interactivo</title>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js para gráficos interactivos -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <!-- MathJax para mostrar fórmulas matemáticas -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        accent: '#f59e0b',
                        dark: '#1f2937',
                    }
                }
            }
        }
    </script>
    <style>
        .function-input {
            font-family: monospace;
        }
        .slider-value {
            min-width: 40px;
            text-align: center;
            background-color: #3b82f6;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.875rem;
            margin-left: 10px;
        }
        #taylorExpression {
            min-height: 60px;
            overflow-x: auto;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-dark mb-2">Visualizador de Series de Taylor</h1>
            <p class="text-gray-600">Explora cómo las series de Taylor aproximan funciones matemáticas</p>
        </header>

        <main class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Panel de controles -->
                <div class="space-y-6">
                    <div>
                        <label for="functionInput" class="block text-sm font-medium text-gray-700 mb-1">Función f(x)</label>
                        <input type="text" id="functionInput" value="sin(x)" 
                            class="function-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        <p class="mt-1 text-sm text-gray-500">Ejemplos: sin(x), cos(x), exp(x), log(x), x^2, etc.</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="xMin" class="block text-sm font-medium text-gray-700 mb-1">Valor mínimo de x</label>
                            <input type="number" id="xMin" value="-5" step="0.5" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label for="xMax" class="block text-sm font-medium text-gray-700 mb-1">Valor máximo de x</label>
                            <input type="number" id="xMax" value="5" step="0.5" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="nTerms" class="block text-sm font-medium text-gray-700">Número de términos (n)</label>
                            <span id="nValue" class="slider-value">5</span>
                        </div>
                        <input type="range" id="nTerms" min="0" max="60" value="5" 
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Colores de las curvas</label>
                        <div class="flex space-x-4">
                            <div class="flex items-center">
                                <label for="funcColor" class="text-sm mr-2">Función:</label>
                                <input type="color" id="funcColor" value="#3b82f6" class="w-8 h-8 cursor-pointer">
                            </div>
                            <div class="flex items-center">
                                <label for="taylorColor" class="text-sm mr-2">Taylor:</label>
                                <input type="color" id="taylorColor" value="#ef4444" class="w-8 h-8 cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <div>
                        <button id="exportBtn" class="w-full bg-primary hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Exportar gráfica como imagen
                        </button>
                    </div>
                </div>

                <!-- Panel de visualización -->
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Aproximación de Taylor</label>
                        <div id="taylorExpression" class="text-sm font-mono"></div>
                    </div>
                    
                    <div id="plot" class="h-80 w-full border border-gray-200 rounded-lg"></div>
                </div>
            </div>
        </main>

        <div class="bg-white rounded-xl shadow-md p-6 text-sm text-gray-600">
            <h2 class="font-medium text-dark mb-2">Instrucciones de uso:</h2>
            <ul class="list-disc pl-5 space-y-1">
                <li>Escribe una función matemática válida en JavaScript (usa 'x' como variable)</li>
                <li>Ajusta el rango de valores de x con los campos mínimo y máximo</li>
                <li>Selecciona el número de términos de la serie con el deslizador</li>
                <li>Observa cómo la aproximación de Taylor se acerca a la función real al aumentar n</li>
                <li>Personaliza los colores de las curvas y exporta la gráfica si lo deseas</li>
            </ul>
        </div>
    </div>

    <script>
        // Variables globales
        let plot;
        let functionColor = '#3b82f6';
        let taylorColor = '#ef4444';

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar event listeners
            document.getElementById('functionInput').addEventListener('input', updatePlot);
            document.getElementById('xMin').addEventListener('input', updatePlot);
            document.getElementById('xMax').addEventListener('input', updatePlot);
            document.getElementById('nTerms').addEventListener('input', function() {
                document.getElementById('nValue').textContent = this.value;
                updatePlot();
            });
            document.getElementById('funcColor').addEventListener('input', function() {
                functionColor = this.value;
                updatePlot();
            });
            document.getElementById('taylorColor').addEventListener('input', function() {
                taylorColor = this.value;
                updatePlot();
            });
            document.getElementById('exportBtn').addEventListener('click', exportPlot);

            // Inicializar el gráfico
            initializePlot();
            updatePlot();
        });

        // Inicializar gráfico Plotly
        function initializePlot() {
            const layout = {
                title: 'Función y su aproximación de Taylor',
                xaxis: {
                    title: 'x',
                    showgrid: true,
                    zeroline: true
                },
                yaxis: {
                    title: 'f(x)',
                    showgrid: true,
                    zeroline: true
                },
                showlegend: true,
                hovermode: 'closest',
                margin: {
                    l: 50,
                    r: 30,
                    b: 40,
                    t: 40,
                    pad: 4
                }
            };

            const config = {
                responsive: true,
                scrollZoom: true,
                displayModeBar: true,
                modeBarButtonsToAdd: [
                    'drawline',
                    'drawopenpath',
                    'drawclosedpath',
                    'drawcircle',
                    'drawrect',
                    'eraseshape'
                ],
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            plot = Plotly.newPlot('plot', [], layout, config);
        }

        // Evaluar una función matemática
        function evaluateFunction(fn, x) {
            try {
                // Reemplazar operadores matemáticos para evaluación segura
                const safeFn = fn
                    .replace(/sin\(/g, 'Math.sin(')
                    .replace(/cos\(/g, 'Math.cos(')
                    .replace(/tan\(/g, 'Math.tan(')
                    .replace(/exp\(/g, 'Math.exp(')
                    .replace(/log\(/g, 'Math.log(')
                    .replace(/sqrt\(/g, 'Math.sqrt(')
                    .replace(/\^/g, '**');
                
                // Evaluar la función con el valor x
                return eval(safeFn);
            } catch (error) {
                console.error("Error al evaluar la función:", error);
                return NaN;
            }
        }

        // Calcular la derivada n-ésima de una función en un punto
        function derivative(fn, x, n) {
            const h = 1e-5; // Pequeño incremento para derivación numérica
            
            if (n === 0) {
                return evaluateFunction(fn, x);
            } else {
                // Usar diferencia central para mayor precisión
                return (derivative(fn, x + h/2, n-1) - derivative(fn, x - h/2, n-1)) / h;
            }
        }

        // Calcular los coeficientes de la serie de Taylor
        function calculateTaylorCoefficients(fn, a = 0, nTerms) {
            const coefficients = [];
            
            for (let n = 0; n <= nTerms; n++) {
                const derivativeAtA = derivative(fn, a, n);
                coefficients.push(derivativeAtA / factorial(n));
            }
            
            return coefficients;
        }

        // Calcular el factorial de un número
        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        // Evaluar la serie de Taylor en un punto x
        function evaluateTaylor(coefficients, x, a = 0) {
            let result = 0;
            
            for (let n = 0; n < coefficients.length; n++) {
                result += coefficients[n] * Math.pow(x - a, n);
            }
            
            return result;
        }

        // Generar expresión LaTeX para la serie de Taylor
        function generateTaylorExpression(coefficients, nTerms) {
            if (nTerms === 0) {
                return "P(x) = 0";
            }
            
            let expression = "P(x) = ";
            const a = 0; // Centro de la serie (puede hacerse configurable en el futuro)
            
            for (let n = 0; n < coefficients.length; n++) {
                const coeff = coefficients[n];
                
                if (Math.abs(coeff) < 1e-10) continue; // Omitir términos muy pequeños
                
                if (n > 0 && coeff >= 0) {
                    expression += " + ";
                } else if (coeff < 0) {
                    expression += " - ";
                }
                
                const absCoeff = Math.abs(coeff);
                let term = "";
                
                if (absCoeff !== 1 || n === 0) {
                    term += absCoeff.toFixed(4);
                }
                
                if (n > 0) {
                    if (term !== "") term += "\\cdot ";
                    term += `(x - ${a})`;
                    if (n > 1) term += `^${n}`;
                }
                
                expression += term;
            }
            
            return expression;
        }

        // Actualizar el gráfico
        function updatePlot() {
            const functionInput = document.getElementById('functionInput').value;
            const xMin = parseFloat(document.getElementById('xMin').value);
            const xMax = parseFloat(document.getElementById('xMax').value);
            const nTerms = parseInt(document.getElementById('nTerms').value);
            
            // Validar entradas
            if (xMin >= xMax) {
                alert("El valor mínimo de x debe ser menor que el máximo");
                return;
            }
            
            // Generar datos para la función original
            const xValues = [];
            const yValuesOriginal = [];
            const step = (xMax - xMin) / 200;
            
            for (let x = xMin; x <= xMax; x += step) {
                xValues.push(x);
                yValuesOriginal.push(evaluateFunction(functionInput, x));
            }
            
            // Calcular coeficientes de Taylor
            const coefficients = calculateTaylorCoefficients(functionInput, 0, nTerms);
            
            // Generar datos para la aproximación de Taylor
            const yValuesTaylor = [];
            for (let x = xMin; x <= xMax; x += step) {
                yValuesTaylor.push(evaluateTaylor(coefficients, x));
            }
            
            // Actualizar la expresión de Taylor
            const taylorExpr = generateTaylorExpression(coefficients, nTerms);
            document.getElementById('taylorExpression').innerHTML = 
                `\\[${taylorExpr}\\]`;
            
            // Renderizar MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typeset();
            }
            
            // Actualizar el gráfico
            const traceOriginal = {
                x: xValues,
                y: yValuesOriginal,
                mode: 'lines',
                name: 'Función original',
                line: {
                    color: functionColor,
                    width: 2
                }
            };
            
            const traceTaylor = {
                x: xValues,
                y: yValuesTaylor,
                mode: 'lines',
                name: `Aproximación (n=${nTerms})`,
                line: {
                    color: taylorColor,
                    width: 2,
                    dash: nTerms > 0 ? 'solid' : 'dash'
                }
            };
            
            const data = [traceOriginal, traceTaylor];
            
            Plotly.react('plot', data, plot.layout, plot.config);
        }

        // Exportar el gráfico como imagen
        function exportPlot() {
            Plotly.downloadImage('plot', {
                format: 'png',
                width: 800,
                height: 600,
                filename: 'serie_taylor'
            });
        }
    </script>
</body>
</html>